<!DOCTYPE html>
<html>
<head>
  <title>Admin - Song Requests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
    }
    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
    }
    th, td {
      border: 1px solid #000;
      padding: 8px;
    }
    th {
      background-color: #000;
      color: white;
    }
    .section-title {
      margin-top: 40px;
      font-size: 1.2em;
    }
    .button {
      margin: 5px;
      padding: 5px 10px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
    }
    .played-btn { background-color: #28a745; }
    .unknown-btn { background-color: #007bff; }
    .reset-btn {
      float: right;
      margin-right: 5%;
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background-color: red;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ¶ Admin - Song Requests ðŸŽ¶</h2>
  <p id="totalRequests">Total Requests: 0</p>
  <button class="reset-btn" onclick="resetTables()">Reset All</button>
  <table id="requestsTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="section-title">âœ… Played Songs</div>
  <table id="playedTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="section-title">ðŸ¤· Songs We Don't Know</div>
  <table id="unknownTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDNwOUT65Dwpzdmxn-3jEWzQV4X7HldEe-X2yB9iwgFVDXUSyLVQoTjukcSf06w-W7uhjaCIrmWxH5/pub?output=csv';
    const appendedRows = new Set();

    function createRow(cells, includeActions = true) {
      const tr = document.createElement('tr');
      cells.forEach(text => {
        const td = document.createElement('td');
        td.textContent = text || 'â€”';
        tr.appendChild(td);
      });
      if (includeActions) {
        const actionCell = document.createElement('td');
        const playedBtn = document.createElement('button');
        playedBtn.textContent = 'Mark as Played';
        playedBtn.className = 'button played-btn';
        playedBtn.onclick = () => moveRow(tr, 'played');

        const unknownBtn = document.createElement('button');
        unknownBtn.textContent = "Don't Know";
        unknownBtn.className = 'button unknown-btn';
        unknownBtn.onclick = () => moveRow(tr, 'unknown');

        actionCell.appendChild(playedBtn);
        actionCell.appendChild(unknownBtn);
        tr.appendChild(actionCell);
      }
      return tr;
    }

    function moveRow(row, destination) {
      const timestamp = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) + ' ' + new Date().toLocaleDateString();
      row.cells[3].textContent = timestamp;
      row.removeChild(row.cells[4]); // Remove action buttons

      if (destination === 'played') {
        document.querySelector('#playedTable tbody').appendChild(row);
      } else {
        document.querySelector('#unknownTable tbody').appendChild(row);
      }
    }

    function resetTables() {
      document.querySelector('#requestsTable tbody').innerHTML = '';
      document.querySelector('#playedTable tbody').innerHTML = '';
      document.querySelector('#unknownTable tbody').innerHTML = '';
      appendedRows.clear();
    }

    function fetchAndAppendNewRows() {
      fetch(sheetURL)
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split('\n').slice(1); // Skip header
          rows.forEach(line => {
            const [song, name, dedication, timestamp, tip] = line.split(',');
            const key = `${song}|${name}|${dedication}`;
            if (!appendedRows.has(key)) {
              appendedRows.add(key);
              const tr = createRow([song, name, dedication, timestamp]);
              document.querySelector('#requestsTable tbody').appendChild(tr);
              document.getElementById('totalRequests').textContent = `Total Requests: ${appendedRows.size}`;
            }
          });
        });
    }

    fetchAndAppendNewRows();
    setInterval(fetchAndAppendNewRows, 5000);
  </script>
</body>
</html>
