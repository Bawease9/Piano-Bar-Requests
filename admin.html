<!DOCTYPE html>
<html>
<head>
  <title>Admin - Song Requests</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #111;
      color: #f1f1f1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 8%;
    }

    h2 {
      margin: 0;
      font-size: 2em;
    }

    #totalRequests {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .reset-btn {
      padding: 10px 16px;
      border-radius: 10px;
      border: none;
      background-color: #e74c3c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    table {
      margin: 0 auto;
      border-collapse: collapse;
      width: 90%;
      margin-bottom: 40px;
    }

    th, td {
      border: 1px solid #333;
      padding: 12px 15px;
    }

    th {
      background-color: #333;
      color: #f1f1f1;
    }

    td:first-child {
      font-weight: bold;
      font-size: 1.1em;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      margin: 30px 0 10px;
      color: #ccc;
    }

    .button {
      margin: 5px;
      padding: 6px 12px;
      font-weight: bold;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
    }

    .played-btn { background-color: #28a745; }
    .unknown-btn { background-color: #007bff; }
    .undo-btn { background-color: #f39c12; }
  </style>
</head>
<body>
  <div class="header">
    <h2>ðŸŽ¶ Admin - Song Requests ðŸŽ¶</h2>
    <button class="reset-btn" onclick="resetTables()">Reset All</button>
  </div>
  <p id="totalRequests">Total Requests: 0</p>

  <table id="requestsTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Submitted</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="section-title">âœ… Played Songs</div>
  <table id="playedTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="section-title">ðŸ¤· Songs We Don't Know</div>
  <table id="unknownTable">
    <thead>
      <tr>
        <th>Song/Artist</th>
        <th>Your Name</th>
        <th>Dedication</th>
        <th>Timestamp</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRDNwOUT65Dwpzdmxn-3jEWzQV4X7HldEe-X2yB9iwgFVDXUSyLVQoTjukcSf06w-W7uhjaCIrmWxH5/pub?output=csv';
    const appendedRows = new Set();

    function timeAgo(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000); // in seconds

      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return `${Math.floor(diff / 86400)}d ago`;
    }

    function createRow(cells, location = 'main') {
      const tr = document.createElement('tr');

      const submittedTime = new Date(cells[3]);
      const submittedText = isNaN(submittedTime.getTime()) ? 'â€”' : timeAgo(submittedTime);

      const visibleCells = [
        cells[0], // song
        cells[1], // name
        cells[2], // dedication
        submittedText // how long ago
      ];

      visibleCells.forEach((text, i) => {
        const td = document.createElement('td');
        td.textContent = text || 'â€”';
        if (i === 0) {
          td.style.fontWeight = 'bold';
          td.style.fontSize = '1.2em';
        }
        tr.appendChild(td);
      });

      const actionCell = document.createElement('td');

      if (location === 'main') {
        const playedBtn = document.createElement('button');
        playedBtn.textContent = 'Mark as Played';
        playedBtn.className = 'button played-btn';
        playedBtn.onclick = () => moveRow(tr, 'played');

        const unknownBtn = document.createElement('button');
        unknownBtn.textContent = "Don't Know";
        unknownBtn.className = 'button unknown-btn';
        unknownBtn.onclick = () => moveRow(tr, 'unknown');

        actionCell.appendChild(playedBtn);
        actionCell.appendChild(unknownBtn);
      } else {
        const undoBtn = document.createElement('button');
        undoBtn.textContent = 'Undo';
        undoBtn.className = 'button undo-btn';
        undoBtn.onclick = () => moveRow(tr, 'main');
        actionCell.appendChild(undoBtn);
      }

      tr.appendChild(actionCell);
      tr.dataset.timestamp = cells[3]; // keep original timestamp for sorting
      return tr;
    }

    function moveRow(row, destination) {
      row.removeChild(row.lastChild);
      const cells = Array.from(row.cells).map(cell => cell.textContent);
      const now = new Date().toISOString();
      const newRow = createRow([...cells.slice(0, 3), now], destination);

      if (destination === 'played') {
        document.querySelector('#playedTable tbody').appendChild(newRow);
      } else if (destination === 'unknown') {
        document.querySelector('#unknownTable tbody').appendChild(newRow);
      } else {
        document.querySelector('#requestsTable tbody').appendChild(newRow);
      }

      row.remove();
    }

    function resetTables() {
      document.querySelector('#requestsTable tbody').innerHTML = '';
      document.querySelector('#playedTable tbody').innerHTML = '';
      document.querySelector('#unknownTable tbody').innerHTML = '';
      appendedRows.clear();
    }

    function fetchAndAppendNewRows() {
      fetch(sheetURL)
        .then(response => response.text())
        .then(csv => {
          const rows = csv.trim().split('\n').slice(1);
          const currentKeys = new Set();
          const parsedRows = [];

          rows.forEach(line => {
            const [song, name, dedication, timestamp] = line.split(',');
            const key = `${song}|${name}|${dedication}`;
            currentKeys.add(key);
            parsedRows.push({ key, data: [song, name, dedication, timestamp] });
          });

          parsedRows
            .sort((a, b) => new Date(b.data[3]) - new Date(a.data[3])) // sort newest first
            .forEach(({ key, data }) => {
              if (!appendedRows.has(key)) {
                appendedRows.add(key);
                const tr = createRow(data);
                document.querySelector('#requestsTable tbody').appendChild(tr);
              }
            });

          appendedRows.forEach(key => {
            if (!currentKeys.has(key)) {
              appendedRows.delete(key);
              const rows = document.querySelectorAll('#requestsTable tbody tr');
              rows.forEach(row => {
                const rowKey = `${row.cells[0].textContent}|${row.cells[1].textContent}|${row.cells[2].textContent}`;
                if (rowKey === key) {
                  row.remove();
                }
              });
            }
          });

          // Re-sort visible rows just in case
          const tbody = document.querySelector('#requestsTable tbody');
          const rowsArray = Array.from(tbody.querySelectorAll('tr'));
          rowsArray.sort((a, b) => new Date(b.dataset.timestamp) - new Date(a.dataset.timestamp));
          rowsArray.forEach(row => tbody.appendChild(row));

          document.getElementById('totalRequests').textContent = `Total Requests: ${appendedRows.size}`;
        });
    }

    fetchAndAppendNewRows();
    setInterval(fetchAndAppendNewRows, 10000);
  </script>
</body>
</html>
